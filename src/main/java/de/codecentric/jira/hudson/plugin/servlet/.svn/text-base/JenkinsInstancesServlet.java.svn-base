package de.codecentric.jira.hudson.plugin.servlet;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.atlassian.sal.api.user.UserManager;
import com.atlassian.templaterenderer.TemplateRenderer;

import static com.google.common.base.Preconditions.checkNotNull;

import de.codecentric.jira.hudson.plugin.ao.ServerService;

public class HudsonInstancesServlet extends HttpServlet {
    private static final String TEMPLATE_PATH = "/templates/admin.vm";
    private final TemplateRenderer templateRenderer;
    private final UserManager userManager;
    private final ServerService serverService;
	
	public HudsonInstancesServlet(TemplateRenderer templateRenderer, ServerService serverService, UserManager userManager) {
        this.templateRenderer = templateRenderer;    	  
        this.serverService = checkNotNull(serverService);
        this.userManager = userManager;
    }
	
	/**
     * Save Entity Server to db.
     * Requires name and url for Server.
     */
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    	String username = userManager.getRemoteUsername(request);
    	//check if user is system-administrator administrator
        if (username != null && (!userManager.isSystemAdmin(username) || !userManager.isAdmin(username)))
        {
        	response.sendError(HttpServletResponse.SC_FORBIDDEN);
            return;
        }
    	String name = request.getParameter("name");
    	String url = request.getParameter("url");
    	String mode = request.getParameter("mode");
    	if(mode.equals("add")){
    		if(!name.equals("") && !url.equals("")){
    			serverService.add(name, url);
    		}	
    	}else if(mode.equals("del")){
    		if(!name.equals("")){
    			serverService.del(name);
    		}
    	}
 
        response.sendRedirect(request.getContextPath() + "/plugins/servlet/hudsoninstances");
    }
    
    /**
     * This function renders the template
     */
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException{
    	String username = userManager.getRemoteUsername(req);
    	//check if user is system-administrator administrator
    	if (username != null && (!userManager.isSystemAdmin(username) || !userManager.isAdmin(username)))
        {
        	resp.sendError(HttpServletResponse.SC_FORBIDDEN);
            return;
        }
    	Map<String, Object> velocityValues = new HashMap<String, Object>();

		velocityValues.put("context", this.getServletContext());
		velocityValues.put("hudsoninstances", this);
		velocityValues.put("serverList", serverService.all());
		
		resp.setContentType("text/html;charset=utf-8"); 
		templateRenderer.render(TEMPLATE_PATH, velocityValues, resp.getWriter());	
    }
}
